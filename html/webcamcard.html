<div class="container-fluid">
    
<div class="container">
	<div id="elementmove" class="row">
		<div id="move1" class="col-lg-7 py-5">
			<div  class="wrappercard">
<div id="possibleCards"></div>
				<div class="card mewtwo animated">
		
        </div>
        <video autoplay="true" id="videoElement" height="480px" width="auto"></video>
        <canvas id="drawCanvas" class='hide' height="480" width="640"></canvas><br/>
    </div>
		   <!-- end wrapper -->

		</div>
		<div id="move2" class="col-lg-5">
			<div class="py-5 px-4 masthead-cards margintoppicture wrapper vcenter-item">
                <div id="possibleCards"></div>
			
				<h1 class="mb-4 text-light">Take picture with your camera</h1>
				<h2 class="m-0">Put the card into camera and shot it, that detect autamtiquely your card and add in your deck list</h2><br />
				<div id="picStuff">
   

                    <button type='button' class="btn btn-danger" id="startCamera" onclick="startcamera()">Start camera</button>
                    <button type='button' class="btn btn-danger" id="stopcamera" onclick="stopcamera()">Stop camera</button>
					<button type='button' class="btn btn-primary" id="snapshot" onclick="snapshot()">Snapshot</button>
					<button type='button' class="btn btn-warning hide"id="retake" onclick="retake()">Retake</button>
					<button type='button' class="btn btn-success hide" id="ocr" onclick="ocr()" >Submit</button>
				</div>
				
				
				
			 
			   
				
			
		</div>
	</div>
</div>
</div>
</div>
<script>
$(function(){
    $('#elementmove2').triggerOnView([
              {
                  element: $('#move3'),
                  default: {left: -300, opacity: 0},
                  in: {left: 0, opacity: 1}
              }
          ]);

       $('#elementmove').triggerOnView([
           {
               element: $('#move1'),
               default: {left: -100, opacity: 0},
               in: {left: 0, opacity: 1}
           },
           {
               element: $('#move2'),
               default: {left: 100, opacity: 0},
               in: {left: 0, opacity: 1}
           }
       ]);

    
   });


   var self = this;

     
		
const video = document.querySelector("#videoElement");
function startCamera() {
if (navigator.mediaDevices.getUserMedia) {
navigator.mediaDevices.getUserMedia({video: true})
.then(function (stream) {
    video.srcObject = stream;
}).catch(function (err) {
    throw new Error("Probl√®me dans le stream !")
});
}
}



$("#stopcamera").addClass('d-none');
$("#retake").addClass('d-none');
 // Trigger starting the camera
 document.getElementById("startCamera").addEventListener("click", function() {
    $(".card").addClass('d-none');
    $("#startCamera").addClass('d-none');
    $("#stopcamera").removeClass('d-none');
    startCamera();
});

var image;
function snapshot(){
    var video = document.getElementById("videoElement");
    var canvas = document.getElementById("drawCanvas");
    var ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, 640, 480);
    image = canvas.toDataURL();
    $(video).addClass('d-none');
    $("#snapshot").addClass('d-none');
    
    $("#retake").removeClass('d-none');
    $(canvas).removeClass('d-none');
    $("#ocr").removeClass('d-none');
}
function retake(){
    $("#videoElement").removeClass('d-none');
    $("#snapshot").removeClass('d-none');
    $("#retake").addClass('d-none');
    $("#drawCanvas").addClass('d-none');
    $("#ocr").addClass('d-none');          
}
var cardName;
function ocr(){
    if (image != undefined){
        $("#threeBurgers").click();
        $("#cardName").text("Loading...");
        $.ajax({
            url: "https://api.ocr.space/parse/image",
            method: "POST",
            data:{
                'apikey': '2a1ffc26e188957',
                'filetype': 'PNG',
                'base64Image': image,
            }
        }).then(function(result){
            console.log(result.ParsedResults[0].ParsedText);
            cardName = result.ParsedResults[0].ParsedText;
            $("#cardName").text(cardName);
            $("#possibleCards").html("<span></span><br/>");
            if (cardName != ""){
                $.ajax({
                    url: "https://api.magicthegathering.io/v1/cards?name=" + cardName,
                    method: "GET"
                }).then(function(cardResults){                        
                    console.log(cardResults);

                    if(cardResults.cards.length != 0){
                        cardResults.cards.forEach(function(card){
                            console.log(card);
                            $("#possibleCards span:last").after('<span><a href="http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=' 
                            + card.multiverseid + '" target="_blank"><img src="' + card.imageUrl +'"/></a></span>');
                            document.getElementById("possibleCards2").value = "Fifth Avenue, New York City";
                            
                           
                                
                            if(card.rulings.length !=0){
                                card.rulings.forEach(function(rule){
                                    $("a:last").after("<p>" + rule.date +" | "+ rule.text + "</p>");
                                });
                            }
                        });
                    }else{
                        $("#threeBurgers").click();
                    }
                });
            }else{
                $("#cardName").text("No words were found.");
                $("#threeBurgers").click();
            }
        })
    }
}

function addtext() {
    var newtext = document.myform.inputtext.value;
    if (document.myform.placement[1].checked) {
        document.myform.outputtext.value = "";
        }
    document.myform.outputtext.value += result;
}


</script>